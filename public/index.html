<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Token Security Experiment</title>
    <style>
        :root {
            --bg: #f7fbff;
            --card: #ffffff;
            --accent: #2b79ff;
            --accent-2: #00b894;
            --muted: #666;
            --danger: #ff4757;
            --warning: #ffa502;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 24px;
            background: var(--bg);
            color: #222;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        h1 {
            margin: 0;
            color: var(--accent);
            font-size: 28px;
        }

        p.desc {
            margin: 6px 0 18px 0;
            color: var(--muted);
        }

        .card {
            background: var(--card);
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(50, 50, 93, 0.07);
            margin-bottom: 18px;
        }

        .card-danger {
            border: 2px solid var(--danger);
            background: #fff5f5;
        }

        .section-title {
            color: var(--accent-2);
            margin: 0 0 10px 0;
            font-size: 18px;
        }

        .section-title-danger {
            color: var(--danger);
        }

        label {
            display: block;
            margin: 6px 0 4px 0;
            color: #333;
            font-weight: 600;
        }

        input[type=text],
        input[type=password],
        textarea {
            padding: 10px;
            width: 100%;
            max-width: 520px;
            border-radius: 6px;
            border: 1px solid #e6eef8;
            font-family: Arial, sans-serif;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        button {
            padding: 10px 14px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--accent);
            color: #fff;
        }

        .btn-sec {
            background: #eef7ff;
            color: var(--accent);
            border: 1px solid rgba(43, 121, 255, 0.12);
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-ghost {
            background: transparent;
            color: var(--accent-2);
            border: 1px dashed #dff6ea;
        }

        .outputs {
            margin-top: 12px;
            font-weight: 600;
            color: #111;
        }

        .hint {
            color: var(--muted);
            font-size: 13px;
            margin-top: 8px;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }

        footer {
            margin-top: 16px;
            font-size: 13px;
            color: var(--muted);
        }

        pre {
            background: #f6f9ff;
            padding: 10px;
            border-radius: 6px;
            overflow: auto;
            max-width: 100%;
            font-size: 12px;
        }

        .warning-box {
            background: #fff9e6;
            border-left: 4px solid var(--warning);
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .attack-result {
            background: #ffe6e6;
            border: 2px solid var(--danger);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-weight: bold;
            color: var(--danger);
        }

        .success-result {
            background: #e6ffe6;
            border: 2px solid var(--accent-2);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-weight: bold;
            color: var(--accent-2);
        }

        .step {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }

        .step-number {
            display: inline-block;
            background: var(--accent);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 8px;
            font-weight: bold;
        }

        .search-result {
            background: #f8f9fa;
            padding: 16px;
            margin: 12px 0;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .comment-box {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #e6eef8;
        }

        .comment-header {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--accent);
        }

        .code-example {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 8px 0;
            overflow-x: auto;
        }

        .malicious-code {
            color: #ff6b6b;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üîí Token Security Experiment</h1>
        </header>
        <p class="desc">This experiment demonstrates <strong>XSS-based token theft</strong> through realistic attack
            vectors (search/comments) and why <strong>HttpOnly cookies</strong> provide better security than client-side
            storage.</p>

        <!-- STEP 1: Setup -->
        <div class="card">
            <div class="section-title">Step 1: Setup Authentication</div>
            <p class="small">First, we'll set up two different authentication methods to compare their security.</p>

            <label for="username">Username</label>
            <input id="username" type="text" placeholder="any name (demo)" value="testuser">
            <label for="password">Password</label>
            <input id="password" type="password" placeholder="any password (demo)" value="password123">

            <div class="row" style="margin-top:12px;">
                <button class="btn-primary" id="btnLoginInsecure">Login (Insecure - JSON Token)</button>
                <button class="btn-sec" id="btnLoginSecure">Login (Secure - HttpOnly Cookie)</button>
            </div>
            <div class="outputs small" id="loginOutput"></div>
            <div class="hint">
                <strong>Insecure:</strong> Returns a token that must be stored by the client (typically in
                localStorage).<br>
                <strong>Secure:</strong> Sets an HttpOnly cookie that JavaScript cannot access.
            </div>
        </div>

        <!-- EDUCATIONAL: Understanding Cookies -->
        <div class="card" style="background: #f0f7ff; border-left: 4px solid var(--accent);">
            <div class="section-title" style="color: var(--accent);">üìö Understanding HTTP Cookies</div>
            <p class="small"><strong>What is a Cookie?</strong> A small piece of data (max 4KB) that a server sends to a
                browser, which the browser stores and sends back with future requests to that server.</p>

            <div style="margin: 16px 0;">
                <strong style="color: var(--accent-2);">How Cookies Work:</strong>
                <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 8px;">
                    <pre style="margin: 0; background: transparent; padding: 0; font-size: 11px;">
1. Client ‚Üí Server:  "I want to login"
2. Server ‚Üí Client:  "OK, here's your auth cookie"
   Header: Set-Cookie: auth_token=xyz; HttpOnly; Secure; SameSite=Strict
3. Browser:          Stores cookie automatically
4. Client ‚Üí Server:  "Give me protected data" + Cookie: auth_token=xyz
5. Server:           Verifies cookie, sends data back</pre>
                </div>
            </div>

            <div style="margin: 16px 0;">
                <strong style="color: var(--accent-2);">Cookie Security Attributes:</strong>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <div style="font-weight: 600; color: var(--accent);">üîí HttpOnly</div>
                        <div class="small">Prevents JavaScript from reading the cookie via document.cookie. Protects
                            against XSS attacks.</div>
                        <div class="small" style="margin-top: 4px; color: var(--accent-2);"><strong>Example:</strong>
                            document.cookie returns empty</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <div style="font-weight: 600; color: var(--accent);">üîê Secure</div>
                        <div class="small">Cookie only sent over HTTPS connections. Prevents network interception (MITM
                            attacks).</div>
                        <div class="small" style="margin-top: 4px; color: var(--accent-2);"><strong>Note:</strong> False
                            in this demo (localhost), true in production</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <div style="font-weight: 600; color: var(--accent);">üõ°Ô∏è SameSite</div>
                        <div class="small">Controls when cookies are sent with cross-site requests. Prevents CSRF
                            attacks.</div>
                        <div class="small" style="margin-top: 4px; color: var(--accent-2);"><strong>Options:</strong>
                            Strict (best), Lax, None</div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 6px;">
                        <div style="font-weight: 600; color: var(--accent);">‚è±Ô∏è Max-Age / Expires</div>
                        <div class="small">Sets cookie expiration time. After expiry, browser deletes it automatically.
                        </div>
                        <div class="small" style="margin-top: 4px; color: var(--accent-2);"><strong>Example:</strong>
                            Max-Age=3600 (1 hour)</div>
                    </div>
                </div>
            </div>

            <div style="margin: 16px 0;">
                <strong style="color: var(--accent-2);">Cookie vs localStorage:</strong>
                <table style="width: 100%; margin-top: 8px; font-size: 12px;">
                    <thead>
                        <tr style="background: var(--accent); color: white;">
                            <th style="padding: 8px; text-align: left;">Feature</th>
                            <th style="padding: 8px; text-align: left;">localStorage</th>
                            <th style="padding: 8px; text-align: left;">HttpOnly Cookie</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: white;">
                            <td style="padding: 8px; font-weight: 600;">JavaScript Access</td>
                            <td style="padding: 8px; color: var(--danger);">‚úÖ Yes (Vulnerable)</td>
                            <td style="padding: 8px; color: var(--accent-2);">‚ùå No (Protected)</td>
                        </tr>
                        <tr style="background: #f9f9f9;">
                            <td style="padding: 8px; font-weight: 600;">Auto-sent with Requests</td>
                            <td style="padding: 8px;">‚ùå No (manual)</td>
                            <td style="padding: 8px;">‚úÖ Yes (automatic)</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 8px; font-weight: 600;">XSS Protection</td>
                            <td style="padding: 8px; color: var(--danger);">‚ùå None</td>
                            <td style="padding: 8px; color: var(--accent-2);">‚úÖ HttpOnly flag</td>
                        </tr>
                        <tr style="background: #f9f9f9;">
                            <td style="padding: 8px; font-weight: 600;">Storage Limit</td>
                            <td style="padding: 8px;">~5-10MB</td>
                            <td style="padding: 8px;">~4KB per cookie</td>
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 8px; font-weight: 600;">Expiration</td>
                            <td style="padding: 8px;">Manual only</td>
                            <td style="padding: 8px;">Automatic (Max-Age)</td>
                        </tr>
                        <tr style="background: #f9f9f9;">
                            <td style="padding: 8px; font-weight: 600;">Best Use Case</td>
                            <td style="padding: 8px;">Preferences, UI state</td>
                            <td style="padding: 8px;">Authentication tokens</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div
                style="background: #fff3cd; border-left: 3px solid #ffc107; padding: 10px; border-radius: 4px; margin-top: 12px;">
                <strong>üéØ Key Takeaway:</strong> HttpOnly cookies are specifically designed to protect authentication
                tokens from JavaScript-based attacks (XSS). They're invisible to document.cookie but automatically
                included in HTTP requests by the browser.
            </div>
        </div>

        <!-- STEP 2: Store Tokens -->
        <div class="card">
            <div class="section-title">Step 2: Store Authentication Tokens</div>
            <p class="small">After login, store the token in localStorage (common but insecure practice).</p>

            <div class="row">
                <button class="btn-primary" id="btnStoreLocal">Store Token in localStorage</button>
                <button class="btn-sec" id="btnGetLocal">View localStorage Token</button>
            </div>
            <div class="outputs small" id="localOutput"></div>

            <div class="hint" style="margin-top: 16px;">
                <strong>Note:</strong> The HttpOnly cookie is already stored by the browser automatically and cannot be
                accessed via JavaScript. Check DevTools ‚Üí Application ‚Üí Cookies to see it.
            </div>
        </div>

        <!-- STEP 3: THE ATTACK - SEARCH XSS -->
        <div class="card card-danger">
            <div class="section-title section-title-danger">‚ö†Ô∏è Step 3A: XSS Attack via Search (Reflected XSS)</div>
            <p class="small">Simulate a real-world attack where malicious JavaScript is injected through a search query.
            </p>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Educational Purpose Only:</strong> This demonstrates how British Airways-style attacks work.
                Never perform such attacks on systems you don't own.
            </div>

            <label for="searchInput">Search Query (Try the attack payload below)</label>
            <input id="searchInput" type="text" placeholder="Enter search query...">
            <button class="btn-primary" id="btnSearch" style="margin-top: 8px;">Search</button>

            <div class="hint">
                <strong>Normal Query:</strong> Try "laptop" or "phone"<br>
                <strong>Attack Payload:</strong> Copy this malicious code:
                <div class="code-example">
                    <span class="malicious-code">&lt;img src=x onerror="let t=localStorage.getItem('token');alert('üö®
                        TOKEN STOLEN: '+t)"&gt;</span>
                </div>
            </div>

            <div id="searchResults"></div>
        </div>

        <!-- STEP 3B: THE ATTACK - COMMENT XSS -->
        <div class="card card-danger">
            <div class="section-title section-title-danger">‚ö†Ô∏è Step 3B: XSS Attack via Comment (Stored XSS)</div>
            <p class="small">Simulate an attack where malicious JavaScript is stored in a comment and executed when
                others view it.</p>

            <label for="commentInput">Post a Comment</label>
            <textarea id="commentInput" placeholder="Write your comment..."></textarea>
            <button class="btn-primary" id="btnPostComment" style="margin-top: 8px;">Post Comment</button>

            <div class="hint">
                <strong>Normal Comment:</strong> "Great article!"<br>
                <strong>Attack Payload:</strong> Copy this malicious code:
                <div class="code-example">
                    <span class="malicious-code">&lt;img src=x onerror="let t=localStorage.getItem('token');alert('üö®
                        COMMENT XSS - STOLEN: '+t)"&gt;</span>
                </div>
            </div>

            <div class="section-title" style="margin-top: 20px;">Comments Section</div>
            <div id="commentsDisplay"></div>
        </div>

        <!-- STEP 4: HttpOnly Cookie Protection -->
        <div class="card">
            <div class="section-title">Step 4: Compare HttpOnly Cookie Protection</div>
            <p class="small">Now try to steal the HttpOnly cookie using the same XSS techniques.</p>

            <label for="searchInputCookie">Search with HttpOnly Cookie Attack</label>
            <input id="searchInputCookie" type="text" placeholder="Enter search query...">
            <button class="btn-sec" id="btnSearchCookie" style="margin-top: 8px;">Search (HttpOnly Test)</button>

            <div class="hint">
                <strong>Attack Payload:</strong> Copy this:
                <div class="code-example">
                    <span class="malicious-code">&lt;img src=x onerror="alert('Cookie: '+document.cookie)"&gt;</span>
                </div>
            </div>

            <div id="searchResultsCookie"></div>
        </div>

        <!-- STEP 5: Verify Legitimate Access -->
        <div class="card">
            <div class="section-title">Step 5: Verify Protection</div>
            <p class="small">Test that both authentication methods still work for legitimate access.</p>

            <div class="row">
                <button class="btn-primary" id="btnGetProtectedInsecure">Access with localStorage Token</button>
                <button class="btn-sec" id="btnGetProtectedSecure">Access with HttpOnly Cookie</button>
            </div>
            <div class="outputs small" id="protectedOutput"></div>
        </div>

        <!-- Summary -->
        <div class="card">
            <div class="section-title">Experiment Summary</div>
            <ul class="small">
                <li><strong>Reflected XSS (Search):</strong> Malicious code in URL/query parameter executes immediately
                    and steals localStorage tokens.</li>
                <li><strong>Stored XSS (Comments):</strong> Malicious code stored in database executes for every user
                    who views it.</li>
                <li><strong>localStorage Vulnerability:</strong> Both attacks successfully steal tokens from
                    localStorage.</li>
                <li><strong>HttpOnly Protection:</strong> Same attacks fail to access HttpOnly cookies - JavaScript is
                    blocked.</li>
                <li><strong>Best Practice:</strong> Always store authentication tokens in HttpOnly cookies with Secure
                    and SameSite flags.</li>
            </ul>
        </div>

        <footer>Prepared for Advanced Computer Security ‚Äì Safe, Local-Only Demonstration</footer>
    </div>

    <script>
        const byId = id => document.getElementById(id);
        const out = (id, txt, isHtml = false) => {
            if (isHtml) byId(id).innerHTML = txt;
            else byId(id).innerText = txt;
        };

        // Step 1: Login buttons
        byId("btnLoginInsecure").onclick = async () => {
            const res = await fetch("/api/login-insecure", { method: "POST" });
            const j = await res.json();
            out("loginOutput", "‚úì Received token: " + j.token);
            window.receivedToken = j.token;
        };

        byId("btnLoginSecure").onclick = async () => {
            const res = await fetch("/api/login-secure", { method: "POST", credentials: "include" });
            const j = await res.json();
            out("loginOutput", "‚úì " + j.message + " (Check DevTools ‚Üí Application ‚Üí Cookies)");
        };

        // Step 2: Store token
        byId("btnStoreLocal").onclick = () => {
            const token = window.receivedToken || "fake-jwt-token-LOCAL-abc123";
            localStorage.setItem("token", token);
            out("localOutput", "‚úì Token stored in localStorage");
        };

        byId("btnGetLocal").onclick = () => {
            const t = localStorage.getItem("token");
            out("localOutput", t ? ("üì¶ localStorage token: " + t) : "‚ùå No token in localStorage");
        };

        // Step 3A: Search XSS (Reflected)
        byId("btnSearch").onclick = async () => {
            const query = byId("searchInput").value;

            if (!query) {
                out("searchResults", "<div class='hint'>Please enter a search query</div>", true);
                return;
            }

            // Send to vulnerable search endpoint
            const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const html = await res.text();

            // Display the response (which includes unsanitized input - XSS!)
            out("searchResults", html, true);
        };

        // Step 3B: Comment XSS (Stored)
        let comments = [];

        byId("btnPostComment").onclick = () => {
            const comment = byId("commentInput").value;

            if (!comment) {
                alert("Please enter a comment");
                return;
            }

            // Store comment (unsanitized - vulnerable!)
            comments.push({
                user: "User" + (comments.length + 1),
                text: comment,
                time: new Date().toLocaleTimeString()
            });

            // Clear input
            byId("commentInput").value = "";

            // Display all comments (XSS executed here!)
            displayComments();
        };

        function displayComments() {
            const container = byId("commentsDisplay");

            if (comments.length === 0) {
                container.innerHTML = "<div class='hint'>No comments yet</div>";
                return;
            }

            // Clear container
            container.innerHTML = "";

            // Create each comment as DOM element (allows script execution)
            comments.forEach(c => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment-box';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'comment-header';
                headerDiv.textContent = `${c.user} ‚Ä¢ ${c.time}`;

                const textDiv = document.createElement('div');
                // VULNERABLE: Using innerHTML allows script execution
                textDiv.innerHTML = c.text;

                commentDiv.appendChild(headerDiv);
                commentDiv.appendChild(textDiv);
                container.appendChild(commentDiv);
            });
        }

        // Step 4: HttpOnly Cookie XSS attempt
        byId("btnSearchCookie").onclick = async () => {
            const query = byId("searchInputCookie").value;

            if (!query) {
                out("searchResultsCookie", "<div class='hint'>Please enter a search query</div>", true);
                return;
            }

            // Try to execute XSS to steal cookie
            const result = `
                <div class="search-result">
                    <h3>Search Results for: ${query}</h3>
                    <p>No results found.</p>
                </div>
            `;

            out("searchResultsCookie", result, true);

            // Automatically check if attack worked
            setTimeout(() => {
                const cookies = document.cookie;
                const hasAuthCookie = cookies.includes('auth_token');

                const resultMsg = `
                    <div class="success-result">
                        ‚úì HttpOnly Cookie Protection Test<br><br>
                        document.cookie = "${cookies || '(empty)'}"<br><br>
                        <strong>Result:</strong> ${hasAuthCookie ? 'Regular cookies visible, but HttpOnly flag prevents JavaScript access to auth_token' : 'HttpOnly cookie NOT accessible to JavaScript - Attack Failed! ‚úì'}<br><br>
                        <span style="font-size: 12px;">Even though XSS executed, the HttpOnly cookie remains protected.</span>
                    </div>
                `;

                out("searchResultsCookie", result + resultMsg, true);
            }, 500);
        };

        // Step 5: Verify both methods work
        byId("btnGetProtectedInsecure").onclick = async () => {
            const t = localStorage.getItem("token") || "";
            const res = await fetch("/api/protected-insecure", {
                headers: { Authorization: "Bearer " + t }
            });
            const txt = await res.text();
            out("protectedOutput", `Response: ${txt}`);
        };

        byId("btnGetProtectedSecure").onclick = async () => {
            const res = await fetch("/api/protected-secure", { credentials: "include" });
            const txt = await res.text();
            out("protectedOutput", `Response: ${txt}`);
        };

        // Initialize empty comments display
        displayComments();
    </script>
</body>

</html>